<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Guru</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f5f7fa;
        min-height: 100vh;
        padding: 1rem;
      }

      .container {
        max-width: 1100px;
      }

      /* Card Styles */
      .dashboard-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e5e7eb;
      }

      /* Header Styles */
      .page-header {
        background: white;
        border-radius: 12px;
        padding: 1.25rem 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #e5e7eb;
      }

      .page-header h1 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
      }

      /* Form Title */
      .form-title {
        color: #1f2937;
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f3f4f6;
      }

      .section-title {
        color: #6b7280;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Form Controls */
      .form-label {
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }

      .form-control,
      .form-select {
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 0.65rem 0.9rem;
        transition: all 0.2s ease;
        font-size: 0.95rem;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
      }

      .form-control:read-only {
        background-color: #f9fafb;
        color: #6b7280;
        font-weight: 500;
      }

      /* Buttons */
      .btn {
        border-radius: 8px;
        padding: 0.65rem 1.25rem;
        font-weight: 500;
        font-size: 0.9rem;
        border: none;
        transition: all 0.2s ease;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
      }

      .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
        transform: translateY(-1px);
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: #6b7280;
        color: white;
      }

      .btn-secondary:hover {
        background: #4b5563;
      }

      .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
      }

      /* Action Buttons */
      .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .btn-action {
        flex: 1;
        min-width: 110px;
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        border-radius: 8px;
        border: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        text-decoration: none;
        white-space: nowrap;
        cursor: pointer;
      }

      .btn-action svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }

      .btn-action-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
      }

      .btn-action-primary:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
      }

      .btn-action-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
      }

      .btn-action-success:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
      }

      .btn-action-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
      }

      .btn-action-danger:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.35);
      }

      .btn-action:active {
        transform: translateY(0);
      }

      @media (max-width: 576px) {
        .action-buttons {
          flex-direction: column;
        }

        .btn-action {
          width: 100%;
          min-width: 100%;
        }
      }

      .table td.action-column {
        min-width: 240px;
      }

      /* Auth Link */
      .auth-link {
        color: #3b82f6;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9rem;
      }

      .auth-link:hover {
        color: #2563eb;
        text-decoration: underline;
      }

      /* Messages */
      .message {
        padding: 0.875rem 1rem;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
        margin-top: 1rem;
        font-size: 0.9rem;
        animation: slideIn 0.3s ease;
      }

      .message.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }

      .message.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Table */
      .table {
        margin-top: 1rem;
        font-size: 0.9rem;
      }

      .table thead {
        background: #f9fafb;
        border-bottom: 2px solid #e5e7eb;
      }

      .table thead th {
        color: #374151;
        font-weight: 600;
        padding: 0.875rem 1rem;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
      }

      .table tbody td {
        padding: 0.875rem 1rem;
        vertical-align: middle;
        color: #1f2937;
      }

      .table-hover tbody tr:hover {
        background: #f9fafb;
      }

      /* Kunci Grid */
      .kunci-grid {
        display: grid;
        grid-template-columns: 60px repeat(5, 1fr);
        gap: 0.75rem;
        align-items: center;
        margin-top: 1.5rem;
      }

      .kunci-grid-header {
        font-weight: 600;
        text-align: center;
        font-size: 0.85rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .kunci-grid .q-number {
        font-weight: 600;
        text-align: right;
        padding-right: 0.75rem;
        color: #374151;
        font-size: 0.95rem;
      }

      .kunci-grid .option-label {
        display: block;
        text-align: center;
        padding: 0.75rem 0.5rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
        background: white;
        user-select: none;
      }

      .kunci-grid input[type="radio"] {
        display: none;
      }

      .kunci-grid input[type="radio"]:checked + .option-label {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }

      .kunci-grid .option-label:hover {
        border-color: #3b82f6;
        background: #eff6ff;
      }

      .kunci-grid input[type="radio"]:checked + .option-label:hover {
        background: #2563eb;
        border-color: #2563eb;
      }

      .kunci-grid .saving-status {
        grid-column: 2 / -1;
        font-style: italic;
        color: #10b981;
        font-size: 0.8rem;
        padding-left: 0.5rem;
        display: none;
      }

      /* Helper Classes */
      .hidden {
        display: none !important;
      }

      .text-muted {
        color: #6b7280 !important;
        font-size: 0.9rem;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .page-header {
          flex-direction: column;
          gap: 1rem;
        }

        .page-header h1 {
          font-size: 1.25rem;
        }

        .dashboard-card {
          padding: 1.25rem;
        }

        .kunci-grid {
          grid-template-columns: 50px repeat(5, 1fr);
          gap: 0.5rem;
        }

        .kunci-grid .option-label {
          padding: 0.6rem 0.4rem;
          font-size: 0.9rem;
        }
      }

      @media (min-width: 992px) {
        .table td.action-column {
          min-width: 360px;
        }
      }

      /* Loading Spinner */
      .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.15em;
      }

      /* Info Box */
      .info-box {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 0.875rem 1rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        color: #1e40af;
      }

      .info-box strong {
        font-weight: 600;
      }

      /* Divider */
      hr {
        border: none;
        border-top: 1px solid #e5e7eb;
        margin: 1.5rem 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div
        id="halamanLogin"
        class="dashboard-card"
        style="max-width: 450px; margin: 3rem auto"
      >
        <div id="loginBox">
          <h2 class="form-title">Login Guru</h2>
          <form id="loginForm">
            <div class="mb-3">
              <label for="loginEmail" class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                id="loginEmail"
                required
                placeholder="guru@sekolah.com"
              />
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label">Password</label>
              <input
                type="password"
                class="form-control"
                id="loginPassword"
                required
                placeholder="Masukkan password"
              />
            </div>
            <button
              type="submit"
              class="btn btn-primary w-100"
              id="loginButton"
            >
              Login
            </button>
          </form>
          <div id="loginMessage"></div>
          <div class="text-center mt-3">
            <a class="auth-link" id="showRegister"
              >Belum punya akun? Register</a
            >
          </div>
        </div>

        <div id="registerBox" class="hidden">
          <h2 class="form-title">Register Guru</h2>
          <form id="registerForm">
            <div class="mb-3">
              <label for="regNama" class="form-label">Nama Guru</label>
              <input
                type="text"
                class="form-control"
                id="regNama"
                required
                placeholder="Nama lengkap"
              />
            </div>
            <div class="mb-3">
              <label for="regEmail" class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                id="regEmail"
                required
                placeholder="guru@sekolah.com"
              />
            </div>
            <div class="mb-3">
              <label for="regMapel" class="form-label">Mata Pelajaran</label>
              <input
                type="text"
                class="form-control"
                id="regMapel"
                required
                placeholder="Matematika"
              />
            </div>
            <div class="mb-3">
              <label for="regPassword" class="form-label">Password</label>
              <input
                type="password"
                class="form-control"
                id="regPassword"
                required
                placeholder="Min. 6 karakter"
              />
            </div>
            <button
              type="submit"
              class="btn btn-primary w-100"
              id="registerButton"
            >
              Register
            </button>
          </form>
          <div id="registerMessage"></div>
          <div class="text-center mt-3">
            <a class="auth-link" id="showLogin">Sudah punya akun? Login</a>
          </div>
        </div>
      </div>

      <div id="halamanDashboard" class="hidden">
        <div class="page-header">
          <h1 id="sapaanGuru">Dashboard</h1>
          <button class="btn btn-danger" id="logoutButton">Logout</button>
        </div>

        <div class="dashboard-card">
          <h2 class="form-title">Buat Ujian Baru</h2>
          <form id="formTambahUjian">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="ujianIdUjian" class="form-label">ID Ujian</label>
                <input
                  type="text"
                  class="form-control"
                  id="ujianIdUjian"
                  required
                  placeholder="UAS_MTK_2025"
                />
              </div>
              <div class="col-md-6 mb-3">
                <label for="ujianNama" class="form-label">Nama Ujian</label>
                <input
                  type="text"
                  class="form-control"
                  id="ujianNama"
                  required
                  placeholder="UAS Matematika 2025"
                />
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="ujianTanggal" class="form-label"
                  >Tanggal Ujian</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="ujianTanggal"
                  required
                />
              </div>
              <div class="col-md-6 mb-3">
                <label for="ujianMapel" class="form-label"
                  >Mata Pelajaran</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="ujianMapel"
                  required
                  placeholder="Matematika"
                />
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Simpan Ujian</button>
          </form>
          <div id="ujianMessage"></div>
        </div>

        <div class="dashboard-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="form-title mb-0">Daftar Ujian</h2>
            <button class="btn btn-success btn-sm" id="btnRefreshUjian">
              <svg
                width="16"
                height="16"
                fill="currentColor"
                viewBox="0 0 16 16"
                style="margin-right: 4px"
              >
                <path
                  fill-rule="evenodd"
                  d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"
                />
                <path
                  d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"
                />
              </svg>
              Refresh
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th style="width: 15%">ID Ujian</th>
                  <th style="width: 25%">Nama Ujian</th>
                  <th style="width: 15%">Tanggal</th>
                  <th style="width: 20%">Mata Pelajaran</th>
                  <th style="width: 25%">Aksi</th>
                </tr>
              </thead>
              <tbody id="tabelDaftarUjian">
                <tr>
                  <td colspan="5" class="text-center text-muted">
                    Klik Refresh...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="halamanKelolaKunci" class="hidden">
        <div class="page-header">
          <h1 id="judulKunci">Kelola Kunci Jawaban</h1>
          <button class="btn btn-secondary" id="btnKembaliKeDashboard_Kunci">
            Kembali
          </button>
        </div>

        <div class="dashboard-card">
          <p class="text-muted text-center mb-4" id="subJudulKunci">
            Mengelola kunci untuk...
          </p>

          <div class="row mb-3 align-items-end">
            <div class="col-md-5">
              <label for="kunciIdUjian" class="form-label">ID Ujian</label>
              <input
                type="text"
                class="form-control"
                id="kunciIdUjian"
                readonly
              />
            </div>
            <div class="col-md-4">
              <label for="kunciJumlahSoal" class="form-label"
                >Jumlah Soal</label
              >
              <input
                type="number"
                class="form-control"
                id="kunciJumlahSoal"
                min="1"
                max="100"
                value="10"
              />
            </div>
            <div class="col-md-3">
              <button class="btn btn-success w-100" id="btnBuatLembarKunci">
                Buat Lembar
              </button>
            </div>
          </div>

          <div id="kunciMessage"></div>

          <div class="info-box">
            <strong>Info:</strong> Klik pada jawaban yang benar. Klik lagi untuk
            mengosongkan. Setiap pilihan akan otomatis tersimpan.
          </div>

          <div id="kunciGridContainer" style="overflow-x: auto">
            <p class="text-muted">
              Masukkan jumlah soal dan klik "Buat Lembar".
            </p>
          </div>
        </div>
      </div>

      <div id="halamanHasilNilai" class="hidden">
        <div class="page-header">
          <h1 id="judulHasilNilai">Hasil Nilai Siswa</h1>
          <button class="btn btn-secondary" id="btnKembaliKeDashboard_Nilai">
            Kembali
          </button>
        </div>

        <div class="dashboard-card">
          <div class="row mb-3 align-items-end">
            <div class="col-md-8">
              <label class="form-label" for="filterIdUjian"
                >Filter ID Ujian</label
              >
              <input
                type="text"
                class="form-control"
                id="filterIdUjian"
                placeholder="Ketik ID Ujian..."
              />
            </div>
            <div class="col-md-4">
              <button class="btn btn-success w-100" id="btnRefreshNilai">
                Tampilkan Hasil
              </button>
            </div>
          </div>

          <div id="nilaiMessage"></div>

          <div class="table-responsive">
            <table class="table table-hover">
              <div id="nilaiMessage"></div>
 
          <div id="aksiMassalContainer" class="hidden mb-3 p-3 bg-light rounded">
            <h5 class="mb-3">Aksi Massal</h5>
            <p class="text-muted small">
              Gunakan tombol ini untuk merilis atau menyembunyikan nilai
              <strong
                >untuk semua siswa</strong
              >
              yang terdaftar di ujian ini.
            </p>
            <div class="d-flex gap-2">
              <button class="btn btn-success" id="btnTampilkanSemua">
                Tampilkan Semua Nilai
              </button>
              <button class="btn btn-secondary" id="btnSembunyikanSemua">
                Sembunyikan Semua Nilai
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID Siswa</th>
                  <th>ID Ujian</th>
                  <th>Benar</th>
                  <th>Salah</th>
                  <th>Nilai</th>
                  <th>Status</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="tabelHasilNilai">
                <tr>
                  <td colspan="7" class="text-center text-muted">
                    Memuat data...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      //
      // const API_URL =
      //   "https://script.google.com/macros/s/AKfycbxOjBQt7Lbj8n7EtmsizEgDlcWDY4dRFM8jdorGXF8Cwlo1zXUkg3k-shXv9McFx2AL/exec";
      const API_URL = "/api/script";
      const loginPage = document.getElementById("halamanLogin");
      const dashboardPage = document.getElementById("halamanDashboard");
      const kelolaKunciPage = document.getElementById("halamanKelolaKunci");
      const hasilNilaiPage = document.getElementById("halamanHasilNilai");
      const loginBox = document.getElementById("loginBox");
      const registerBox = document.getElementById("registerBox");

      let cacheUjian = null;

      function showMessage(elementId, message, isError = false) {
        const messageDiv = document.getElementById(elementId);
        const className = isError ? "message error" : "message success";
        messageDiv.innerHTML = `<div class="${className}">${message}</div>`;
        setTimeout(() => {
          messageDiv.innerHTML = "";
        }, 5000);
      }

      function setLoading(button, isLoading) {
        button.disabled = isLoading;
        button.innerHTML = isLoading
          ? '<span class="spinner-border spinner-border-sm"></span> Memproses...'
          : button.dataset.text;
      }

      function showLoginBox() {
        loginBox.classList.remove("hidden");
        registerBox.classList.add("hidden");
      }

      function showRegisterBox() {
        loginBox.classList.add("hidden");
        registerBox.classList.remove("hidden");
      }

      function showDashboard() {
        const nama = localStorage.getItem("guru_nama") || "Guru";
        document.getElementById("sapaanGuru").textContent = `Halo, ${nama}`;
        loginPage.classList.add("hidden");
        kelolaKunciPage.classList.add("hidden");
        hasilNilaiPage.classList.add("hidden");
        dashboardPage.classList.remove("hidden");
        loadDaftarUjian();
      }

      function showLoginPage() {
        localStorage.clear();
        cacheUjian = null;
        loginPage.classList.remove("hidden");
        dashboardPage.classList.add("hidden");
        kelolaKunciPage.classList.add("hidden");
        hasilNilaiPage.classList.add("hidden");
        showLoginBox();
      }

      function showKelolaKunciPage() {
        loginPage.classList.add("hidden");
        dashboardPage.classList.add("hidden");
        hasilNilaiPage.classList.add("hidden");
        kelolaKunciPage.classList.remove("hidden");
      }

      function showHasilNilaiPage() {
        loginPage.classList.add("hidden");
        dashboardPage.classList.add("hidden");
        kelolaKunciPage.classList.add("hidden");
        hasilNilaiPage.classList.remove("hidden");
      }

      async function apiFetch(action, data, auth = false) {
        try {
          let body = { action, data };
          if (auth) {
            const email = localStorage.getItem("guru_email");
            const password = localStorage.getItem("guru_password");
            if (!email || !password)
              throw new Error(
                "Sesi login tidak ditemukan. Silakan login ulang."
              );
            body.auth = { email, password };
          }
          console.log("üì§ Request:", action, body);
          const response = await fetch(API_URL, {
            method: "POST",
            redirect: "follow",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(body),
          });
          console.log("üì• Status:", response.status);
          const text = await response.text();
          console.log("üìÑ Response:", text);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const result = JSON.parse(text);
          if (result.status !== "success")
            throw new Error(result.message || "API Error");
          return result;
        } catch (error) {
          console.error("‚ùå Error:", error);
          throw error;
        }
      }

      // ======================================================
      // PERBAIKAN FUNGSI apiGet
      // ======================================================
      async function apiGet(action, params = "", auth = false) { // <-- DITAMBAH 'auth = false'
        try {
          // --- KODE BARU UNTUK OTENTIKASI ---
          let authParams = "";
          if (auth) {
            const email = localStorage.getItem("guru_email");
            const password = localStorage.getItem("guru_password");
            if (!email || !password) {
              throw new Error("Sesi login tidak ditemukan. Silakan login ulang.");
            }
            // Kirim email dan password sebagai parameter URL
            authParams = `&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`;
          }
          // --- BATAS KODE BARU ---

          const url = `${API_URL}?action=${action}${params}${authParams}&_=${Date.now()}`; // <-- DITAMBAH authParams
          
          console.log("üì§ GET:", url);
          const response = await fetch(url, {
            method: "GET",
            redirect: "follow",
          });
          const text = await response.text();
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const result = JSON.parse(text);
          if (result.status !== "success")
            throw new Error(result.message || "API Error");
          return result;
        } catch (error) {
          console.error("‚ùå Error:", error);
          throw error;
        }
      }
      // ======================================================
      // SELESAI PERBAIKAN apiGet
      // ======================================================

      document
        .getElementById("registerForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = e.target.querySelector("button");
          btn.dataset.text = btn.innerHTML;
          setLoading(btn, true);
          try {
            await apiFetch(
              "registerGuru",
              {
                nama_guru: document.getElementById("regNama").value,
                email: document.getElementById("regEmail").value,
                mapel: document.getElementById("regMapel").value,
                password: document.getElementById("regPassword").value,
              },
              false
            );
            showMessage(
              "registerMessage",
              "‚úÖ Registrasi berhasil! Silakan login.",
              false
            );
            e.target.reset();
            setTimeout(showLoginBox, 2000);
          } catch (error) {
            showMessage("registerMessage", `‚ùå ${error.message}`, true);
          } finally {
            setLoading(btn, false);
          }
        });

      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = e.target.querySelector("button");
          btn.dataset.text = btn.innerHTML;
          setLoading(btn, true);
          const email = document.getElementById("loginEmail").value;
          const password = document.getElementById("loginPassword").value;
          try {
            const result = await apiFetch(
              "loginGuru",
              { email, password },
              false
            );
            localStorage.setItem("guru_id", result.data.id_guru);
            localStorage.setItem("guru_nama", result.data.nama_guru);
            localStorage.setItem("guru_email", email);
            localStorage.setItem("guru_password", password);
            showMessage("loginMessage", "‚úÖ Login berhasil!", false);
            setTimeout(showDashboard, 1000);
          } catch (error) {
            showMessage("loginMessage", `‚ùå ${error.message}`, true);
          } finally {
            setLoading(btn, false);
          }
        });

      document
        .getElementById("formTambahUjian")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = e.target.querySelector("button");
          btn.dataset.text = btn.innerHTML;
          setLoading(btn, true);
          try {
            await apiFetch(
              "addUjian",
              {
                id_ujian: document.getElementById("ujianIdUjian").value,
                nama_ujian: document.getElementById("ujianNama").value,
                tanggal_ujian: document.getElementById("ujianTanggal").value,
                mata_pelajaran: document.getElementById("ujianMapel").value,
              },
              true
            );
            showMessage("ujianMessage", "‚úÖ Ujian berhasil disimpan!", false);
            e.target.reset();
            loadDaftarUjian(true);
          } catch (error) {
            showMessage("ujianMessage", `‚ùå ${error.message}`, true);
          } finally {
            setLoading(btn, false);
          }
        });

      function renderTabelUjian(data) {
        const tableBody = document.getElementById("tabelDaftarUjian");
        if (data && data.length > 0) {
          tableBody.innerHTML = data
            .map(
              (ujian) => `
                <tr>
                  <td><strong>${ujian.id_ujian}</strong></td>
                  <td>${ujian.nama_ujian}</td>
                  <td>${new Date(ujian.tanggal_ujian).toLocaleDateString(
                    "id-ID"
                  )}</td>
                  <td>${ujian.mata_pelajaran}</td>
                  <td class="action-column">
                    <div class="action-buttons">
                      <button class='btn-action btn-action-primary' onclick='kelolaKunci("${
                        ujian.id_ujian
                      }", "${ujian.nama_ujian}")'>
                        <svg fill="currentColor" viewBox="0 0 16 16">
                          <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                        Kelola Kunci
                      </button>
                      <button class='btn-action btn-action-success' onclick='lihatHasilNilai("${
                        ujian.id_ujian
                      }")'>
                        <svg fill="currentColor" viewBox="0 0 16 16">
                          <path d="M5.5 7a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zM5 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/>
                          <path d="M9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.5L9.5 0zm0 1v2A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                        </svg>
                        Lihat Nilai
                      </button>
                      
                      <button class='btn-action btn-action-danger' onclick='hapusUjian("${
                        ujian.id_ujian
                      }")'>
                        <svg fill="currentColor" viewBox="0 0 16 16">
                           <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                           <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                        Hapus
                      </button>
                    </div>
                  </td>
                </tr>
              `
            )
            .join("");
        } else {
          tableBody.innerHTML =
            '<tr><td colspan="5" class="text-center text-muted">Belum ada ujian.</td></tr>';
        }
      }

      // ======================================================
      // PERBAIKAN FUNGSI loadDaftarUjian
      // ======================================================
      async function loadDaftarUjian(forceRefresh = false) {
        if (forceRefresh) cacheUjian = null;
        if (cacheUjian) {
          renderTabelUjian(cacheUjian);
          return;
        }
        const tableBody = document.getElementById("tabelDaftarUjian");
        tableBody.innerHTML =
          '<tr><td colspan="5" class="text-center text-muted">Memuat data...</td></tr>';
        try {
          // --- PERUBAHAN DI SINI ---
          // Ganti dari apiFetch ke apiGet dengan otentikasi
          const result = await apiGet("getUjianGuru", "", true);
          // --- BATAS PERUBAHAN ---
          
          cacheUjian = result.data;
          renderTabelUjian(cacheUjian);
        } catch (error) {
          tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">‚ùå ${error.message}</td></tr>`;
        }
      }
      // ======================================================
      // SELESAI PERBAIKAN loadDaftarUjian
      // ======================================================

      async function kelolaKunci(id_ujian, nama_ujian) {
        document.getElementById(
          "judulKunci"
        ).textContent = `Kunci: ${nama_ujian}`;
        document.getElementById(
          "subJudulKunci"
        ).textContent = `ID Ujian: ${id_ujian}`;
        document.getElementById("kunciIdUjian").value = id_ujian;
        document.getElementById("kunciGridContainer").innerHTML =
          '<p class="text-muted">Memuat...</p>';
        document.getElementById("kunciJumlahSoal").value = "10";
        document.getElementById("kunciMessage").innerHTML = "";
        showKelolaKunciPage();
        await generateKunciGrid(false);
      }

      // ======================================================
      // PERBAIKAN FUNGSI generateKunciGrid
      // ======================================================
      async function generateKunciGrid(isButtonTrigger = false) {
        const btn = document.getElementById("btnBuatLembarKunci");

        if (isButtonTrigger) {
          btn.dataset.text = btn.innerHTML;
          setLoading(btn, true);
        }

        const gridContainer = document.getElementById("kunciGridContainer");
        const idUjian = document.getElementById("kunciIdUjian").value;
        const totalSoal =
          parseInt(document.getElementById("kunciJumlahSoal").value) || 0;

        if (totalSoal < 1 || totalSoal > 100) {
          showMessage(
            "kunciMessage",
            "‚ùå Jumlah soal harus antara 1 dan 100.",
            true
          );
          if (isButtonTrigger) setLoading(btn, false);
          return;
        }

        gridContainer.innerHTML =
          '<p class="text-muted">Memuat kunci jawaban...</p>';

        let existingKeys = {};
        try {
          // --- PERUBAHAN DI SINI ---
          // Tambahkan parameter 'auth: true'
          const result = await apiGet(
            "getKunciJawaban",
            `&id_ujian=${idUjian}`,
            true // <-- Tambahkan ini
          );
          // --- BATAS PERUBAHAN ---
          existingKeys = result.data;
        } catch (error) {
          showMessage("kunciMessage", `‚ö†Ô∏è Belum ada kunci tersimpan.`, false);
        }

        let gridHtml = `
          <div class="kunci-grid">
            <div class="kunci-grid-header">No</div>
            <div class="kunci-grid-header">A</div>
            <div class="kunci-grid-header">B</div>
            <div class="kunci-grid-header">C</div>
            <div class="kunci-grid-header">D</div>
            <div class="kunci-grid-header">E</div>
        `;

        const options = ["A", "B", "C", "D", "E"];

        for (let i = 1; i <= totalSoal; i++) {
          const currentKey = existingKeys[i] || "";
          gridHtml += `<div class="q-number">${i}</div>`;

          options.forEach((opt) => {
            const radioId = `soal_${i}_${opt}`;
            const isChecked = currentKey === opt ? "checked" : "";

            gridHtml += `
              <div>
                <input type_="radio" name="soal_${i}" id="${radioId}" value="${opt}" ${isChecked} style="display:none">
                <label class="option-label" for="${radioId}" data-nomor="${i}" data-jawaban="${opt}">
                  ${opt}
                </label>
              </div>
            `;
          });

          gridHtml += `<div class="saving-status" id="status_soal_${i}"></div>`;
        }

        gridHtml += "</div>";
        gridContainer.innerHTML = gridHtml;
        gridContainer.innerHTML = gridContainer.innerHTML.replace(
          /type_=/g,
          "type="
        );

        // Attach event listeners setelah HTML di-render
        document.querySelectorAll(".option-label").forEach((label) => {
          label.addEventListener("click", function (e) {
            e.preventDefault();
            const nomorSoal = parseInt(this.dataset.nomor);
            const jawaban = this.dataset.jawaban;
            const radioId = `soal_${nomorSoal}_${jawaban}`;
            const radioElement = document.getElementById(radioId);

            const wasChecked = radioElement.checked;

            if (wasChecked) {
              radioElement.checked = false;
              handleKunciDelete(nomorSoal, jawaban);
            } else {
              const allRadios = document.querySelectorAll(
                `input[name="soal_${nomorSoal}"]`
              );
              allRadios.forEach((r) => (r.checked = false));
              radioElement.checked = true;
              handleKunciSave(radioElement, nomorSoal);
            }
          });
        });

        if (isButtonTrigger) {
          setLoading(btn, false);
        }
      }
      // ======================================================
      // SELESAI PERBAIKAN generateKunciGrid
      // ======================================================

      // ======================================================
      // PERBAIKAN FUNGSI loadNilaiSiswa
      // ======================================================
      async function loadNilaiSiswa() {
        const tableBody = document.getElementById("tabelHasilNilai");
        const aksiContainer = document.getElementById("aksiMassalContainer");
        const idUjian = document.getElementById("filterIdUjian").value;

        if (!idUjian) {
          showMessage("nilaiMessage", "‚ùå ID Ujian tidak boleh kosong", true);
          return;
        }

        // Sembunyikan tombol aksi saat memuat
        aksiContainer.classList.add("hidden");
        tableBody.innerHTML =
          '<tr><td colspan="7" class="text-center text-muted">Memuat data nilai...</td></tr>';
        try {
          // --- PERUBAHAN DI SINI ---
          // Tambahkan parameter 'auth: true'
          const result = await apiGet(
            "getHasilNilai",
            `&id_ujian=${idUjian}`,
            true // <-- Tambahkan ini
          );
          // --- BATAS PERUBAHAN ---
          
          if (result.data.length > 0) {
            tableBody.innerHTML = result.data
              .map((nilai) => {
                const status = nilai.status_nilai || "Sembunyi";
                const isPublished = status === "Tampil";
                const btnClass = isPublished
                  ? "btn-secondary"
                  : "btn-success";
                const btnText = isPublished ? "Sembunyikan" : "Tampilkan";
                const newStatus = isPublished ? "Sembunyi" : "Tampil";

                return `
                <tr>
                  <td>${nilai.id_siswa}</td>
                  <td>${nilai.id_ujian}</td>
                  <td>${nilai.benar}</td>
                  <td>${nilai.salah}</td>
                  
                  <td>
                    <div class="input-group input-group-sm" style="width: 130px;">
                      <input 
                        type="number" 
                        class="form-control" 
                        id="nilai-${nilai.waktu_koreksi}" 
                        value="${nilai.nilai || ''}"
                        placeholder="0">
                      <button 
                        class="btn btn-outline-primary" 
                        type="button" 
                        id="btn-simpan-${nilai.waktu_koreksi}"
                        onclick="simpanNilaiBaru(this, '${nilai.waktu_koreksi}')">
                        Simpan
                      </button>
                    </div>
                  </td>
                  <td>
                    <span 
                      class="badge ${
                        isPublished ? "bg-success" : "bg-secondary"
                      }" 
                      id="status-${nilai.id_siswa}">
                      ${status}
                    </span>
                  </td>
                  <td>
                    <button 
                      class="btn ${btnClass} btn-sm" 
                      id="btn-aksi-${nilai.id_siswa}"
                      onclick="updateStatusNilai(this, '${nilai.id_siswa}', '${
                  nilai.id_ujian
                }', '${newStatus}')">
                      ${btnText}
                    </button>
                  </td>
                </tr>
              `;
              })
              .join("");

            // --- KODE BARU: Tampilkan tombol & pasang listener ---
            aksiContainer.classList.remove("hidden");
            document.getElementById("btnTampilkanSemua").onclick = () =>
              updateSemuaStatusNilai(idUjian, "Tampil");
            document.getElementById("btnSembunyikanSemua").onclick = () =>
              updateSemuaStatusNilai(idUjian, "Sembunyi");
            // --- BATAS KODE BARU ---
          } else {
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tidak ada data untuk ${idUjian}</td></tr>`;
          }
        } catch (error) {
          tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">‚ùå ${error.message}</td></tr>`;
        }
      }
      // ======================================================
      // SELESAI PERBAIKAN loadNilaiSiswa
      // ======================================================

      function handleLabelClick(event, radioId, nomorSoal, jawaban) {
        event.preventDefault();
        event.stopPropagation();

        const radioElement = document.getElementById(radioId);
        const wasChecked = radioElement.checked;

        if (wasChecked) {
          // Jika sudah ter-check, uncheck dan hapus dari server
          radioElement.checked = false;
          handleKunciDelete(nomorSoal, jawaban);
        } else {
          // Jika belum ter-check, check dan simpan ke server
          // Uncheck semua radio di group ini dulu
          const allRadios = document.querySelectorAll(
            `input[name="soal_${nomorSoal}"]`
          );
          allRadios.forEach((r) => (r.checked = false));

          // Check radio yang dipilih
          radioElement.checked = true;
          handleKunciSave(radioElement, nomorSoal);
        }
      }

      function handleKunciClick(radioElement, nomorSoal) {
        const wasChecked = radioElement.oldChecked === true;

        if (wasChecked) {
          radioElement.checked = false;
          handleKunciDelete(nomorSoal, radioElement.value);
        } else {
          handleKunciSave(radioElement, nomorSoal);
        }
      }

      async function handleKunciSave(radioElement, nomorSoal) {
        const idUjian = document.getElementById("kunciIdUjian").value;
        const jawabanBenar = radioElement.value;
        const statusEl = document.getElementById(`status_soal_${nomorSoal}`);

        if (statusEl) {
          statusEl.textContent = "Menyimpan...";
          statusEl.style.color = "#6b7280";
          statusEl.style.display = "block";
        }

        try {
          await apiFetch(
            "addKunciJawaban",
            {
              id_ujian: idUjian,
              nomor_soal: nomorSoal,
              jawaban_benar: jawabanBenar,
            },
            true
          );

          if (statusEl) {
            statusEl.textContent = `‚úì Tersimpan`;
            statusEl.style.color = "#10b981";
            setTimeout(() => {
              if (statusEl) statusEl.style.display = "none";
            }, 2000);
          }
        } catch (error) {
          if (statusEl) {
            statusEl.textContent = `‚úó Gagal`;
            statusEl.style.color = "#ef4444";
          }
          showMessage(
            "kunciMessage",
            `‚ùå Gagal menyimpan Soal ${nomorSoal}`,
            true
          );
        }
      }

      async function handleKunciDelete(nomorSoal, jawabanValue) {
        const idUjian = document.getElementById("kunciIdUjian").value;
        const statusEl = document.getElementById(`status_soal_${nomorSoal}`);

        if (statusEl) {
          statusEl.textContent = "Menghapus...";
          statusEl.style.color = "#ef4444";
          statusEl.style.display = "block";
        }

        try {
          await apiFetch(
            "deleteKunciJawaban",
            {
              id_ujian: idUjian,
              nomor_soal: nomorSoal,
            },
            true
          );

          const radios = document.querySelectorAll(
            `input[name="soal_${nomorSoal}"]`
          );
          radios.forEach((r) => {
            r.checked = false;
            r.oldChecked = false;
          });

          if (statusEl) {
            statusEl.textContent = `‚úì Dihapus`;
            statusEl.style.color = "#6b7280";
            setTimeout(() => {
              if (statusEl) statusEl.style.display = "none";
            }, 2000);
          }
        } catch (error) {
          if (statusEl) {
            statusEl.textContent = `‚úó Gagal Hapus`;
            statusEl.style.color = "#ef4444";
          }
          showMessage(
            "kunciMessage",
            `‚ùå Gagal menghapus Soal ${nomorSoal}`,
            true
          );
        }
      }

      // ======================================================
      // TAMBAHKAN FUNGSI BARU INI (1 dari 2)
      // ======================================================
      async function updateSemuaStatusNilai(idUjian, newStatus) {
        const isTampil = newStatus === "Tampil";
        const btn = isTampil
          ? document.getElementById("btnTampilkanSemua")
          : document.getElementById("btnSembunyikanSemua");
        const actionText = isTampil ? "Menampilkan" : "Menyembunyikan";

        if (
          !confirm(
            `Anda yakin ingin ${actionText.toLowerCase()} semua nilai untuk ${idUjian}?`
          )
        )
          return;

        btn.dataset.text = btn.innerHTML;
        setLoading(btn, true);

        try {
          await apiFetch(
            "updateStatusNilaiSemua", // <-- AKSI BARU
            {
              id_ujian: idUjian,
              status_nilai: newStatus,
            },
            true // Requires auth
          );

          // Update UI secara massal
          updateTabelUIMassal(newStatus);
          showMessage(
            "nilaiMessage",
            `‚úÖ Berhasil ${actionText.toLowerCase()} semua nilai.`,
            false
          );
        } catch (error) {
          showMessage("nilaiMessage", `‚ùå Gagal update: ${error.message}`, true);
        } finally {
          setLoading(btn, false);
        }
      }

      // ======================================================
      // TAMBAHKAN FUNGSI BARU INI (2 dari 2)
      // ======================================================
      function updateTabelUIMassal(newStatus) {
        const isTampil = newStatus === "Tampil";
        const idUjian = document.getElementById("filterIdUjian").value;

        // Loop semua baris di tabel
        document
          .querySelectorAll("#tabelHasilNilai tr")
          .forEach((row) => {
            const statusBadge = row.querySelector("span.badge");
            const aksiButton = row.querySelector("button.btn-sm");
            const idSiswa = row.cells[0].textContent; // Ambil id_siswa

            if (statusBadge && aksiButton) {
              if (isTampil) {
                statusBadge.textContent = "Tampil";
                statusBadge.classList.remove("bg-secondary");
                statusBadge.classList.add("bg-success");

                aksiButton.textContent = "Sembunyikan";
                aksiButton.classList.remove("btn-success");
                aksiButton.classList.add("btn-secondary");
                aksiButton.onclick = () =>
                  updateStatusNilai(
                    aksiButton,
                    idSiswa,
                    idUjian,
                    "Sembunyi"
                  );
              } else {
                statusBadge.textContent = "Sembunyi";
                statusBadge.classList.remove("bg-success");
                statusBadge.classList.add("bg-secondary");

                aksiButton.textContent = "Tampilkan";
                aksiButton.classList.remove("btn-secondary");
                aksiButton.classList.add("btn-success");
                aksiButton.onclick = () =>
                  updateStatusNilai(
                    aksiButton,
                    idSiswa,
                    idUjian,
                    "Tampil"
                  );
              }
            }
          });
      }
      
      // ======================================================
      // TAMBAHKAN FUNGSI BARU INI (UNTUK EDIT NILAI)
      // ======================================================
      async function simpanNilaiBaru(button, waktuKoreksi) {
        button.dataset.text = button.innerHTML;
        setLoading(button, true);

        const inputEl = document.getElementById(`nilai-${waktuKoreksi}`);
        const nilaiBaru = inputEl.value;

        try {
          await apiFetch(
            "editNilai", // <-- Aksi baru kita
            {
              waktu_koreksi: waktuKoreksi,
              nilai_baru: nilaiBaru,
            },
            true // Membutuhkan otentikasi guru
          );

          // Beri umpan balik visual
          inputEl.style.borderColor = "green";
          inputEl.style.backgroundColor = "#d1fae5";
          showMessage(
            "nilaiMessage",
            `‚úÖ Nilai untuk baris ${waktuKoreksi.slice(-6)} berhasil disimpan.`,
            false
          );
          setTimeout(() => {
            inputEl.style.borderColor = "";
            inputEl.style.backgroundColor = "";
          }, 2500);

        } catch (error) {
          inputEl.style.borderColor = "red";
          showMessage(
            "nilaiMessage",
            `‚ùå Gagal simpan: ${error.message}`,
            true
          );
        } finally {
          setLoading(button, false);
        }
      }

      // ======================================================
      // FUNGSI BARU updateStatusNilai
      // ======================================================
      async function updateStatusNilai(button, idSiswa, idUjian, newStatus) {
        button.dataset.text = button.innerHTML;
        setLoading(button, true);
        try {
          await apiFetch(
            "updateStatusNilai",
            {
              id_siswa: idSiswa,
              id_ujian: idUjian,
              status_nilai: newStatus,
            },
            true // Membutuhkan otentikasi guru
          );

          // Update UI secara manual tanpa reload
          const statusBadge = document.getElementById(`status-${idSiswa}`);
          const isPublished = newStatus === "Tampil";

          if (isPublished) {
            statusBadge.textContent = "Tampil";
            statusBadge.classList.remove("bg-secondary");
            statusBadge.classList.add("bg-success");
            button.textContent = "Sembunyikan";
            button.classList.remove("btn-success");
            button.classList.add("btn-secondary");
            // Update onclick untuk aksi berikutnya
            button.onclick = () =>
              updateStatusNilai(button, idSiswa, idUjian, "Sembunyi");
          } else {
            statusBadge.textContent = "Sembunyi";
            statusBadge.classList.remove("bg-success");
            statusBadge.classList.add("bg-secondary");
            button.textContent = "Tampilkan";
            button.classList.remove("btn-secondary");
            button.classList.add("btn-success");
            // Update onclick untuk aksi berikutnya
            button.onclick = () =>
              updateStatusNilai(button, idSiswa, idUjian, "Tampil");
          }
        } catch (error) {
          showMessage(
            "nilaiMessage",
            `‚ùå Gagal update: ${error.message}`,
            true
          );
        } finally {
          setLoading(button, false);
        }
      }

      function lihatHasilNilai(id_ujian) {
        document.getElementById("filterIdUjian").value = id_ujian;
        document.getElementById(
          "judulHasilNilai"
        ).textContent = `Nilai: ${id_ujian}`;
        showHasilNilaiPage();
        loadNilaiSiswa();
      }

      async function hapusUjian(id_ujian) {
        if (
          !confirm(
            `Apakah Anda yakin ingin menghapus ujian ${id_ujian}?\nData ujian dan kunci jawaban terkait akan hilang permanen.`
          )
        ) {
          return;
        }
        showMessage("ujianMessage", "Menghapus ujian...", false);
        try {
          await apiFetch("deleteUjian", { id_ujian: id_ujian }, true);
          showMessage(
            "ujianMessage",
            `‚úÖ Ujian ${id_ujian} berhasil dihapus.`,
            false
          );
          loadDaftarUjian(true);
        } catch (error) {
          showMessage(
            "ujianMessage",
            `‚ùå Gagal menghapus: ${error.message}`,
            true
          );
        }
      }

      //
      document
        .getElementById("logoutButton")
        .addEventListener("click", showLoginPage);
      document
        .getElementById("showRegister")
        .addEventListener("click", showRegisterBox);
      document
        .getElementById("showLogin")
        .addEventListener("click", showLoginBox);
      document
        .getElementById("btnKembaliKeDashboard_Kunci")
        .addEventListener("click", showDashboard);
      document
        .getElementById("btnKembaliKeDashboard_Nilai")
        .addEventListener("click", showDashboard);
      document
        .getElementById("btnRefreshUjian")
        .addEventListener("click", () => loadDaftarUjian(true));
      document
        .getElementById("btnRefreshNilai")
        .addEventListener("click", loadNilaiSiswa);
      document
        .getElementById("btnBuatLembarKunci")
        .addEventListener("click", () => generateKunciGrid(true));

      window.addEventListener("load", () => {
        console.log("üöÄ App Started | API:", API_URL);
        localStorage.getItem("guru_id") ? showDashboard() : showLoginPage();
      });
    </script>
  </body>
</html>